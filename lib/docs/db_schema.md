# DATABASE SCHEMA (SOURCE OF TRUTH)

This document is the ONLY valid database reference.

---

## TABLE: lessons

### Columns
| column | type | nullable | default | notes |
|------|------|---------|---------|------|
| id | bigserial | no | auto | primary key |
| name | text | no | — | unique |
| icon | text | yes | — | |
| description | text | yes | — | |
| order_no | integer | yes | 0 | sorting |
| created_at | timestamptz | yes | now() | |

### SQL source
```sql
create table public.lessons (
  id bigserial not null,
  name text not null,
  icon text null,
  description text null,
  order_no integer null default 0,
  created_at timestamp with time zone null default now(),
  constraint lessons_pkey primary key (id),
  constraint lessons_name_key unique (name)
);


---------------------------------------------------------------------------------------------------

## TABLE: units

### Columns
| column | type | nullable | default | notes |
|------|------|---------|---------|------|
| id | bigint | no | auto | primary key |
| title | text | no | — | |
| order_no | integer | no | 0 | sorting |
| grade_id | integer | no | — | FK → grades.id |
| lesson_id | integer | no | — | FK → lessons.id |

### SQL source 


```sql
create table public.units (
  id bigint generated by default as identity not null,
  title text not null,
  order_no integer not null default 0,
  grade_id integer not null,
  lesson_id integer not null,
  constraint units_pkey primary key (id),
  constraint fk_units_grade foreign key (grade_id) references grades (id) on delete cascade,
  constraint fk_units_lesson foreign key (lesson_id) references lessons (id) on delete cascade
);

---------------------------------------------------------------------------------------------

## TABLE: topics

### Columns
| column | type | nullable | default | notes |
|------|------|---------|---------|------|
| id | bigint | no | auto | primary key |
| unit_id | bigint | no | — | FK → units.id |
| title | text | no | — | |
| slug | text | yes | — | auto-generated |
| order_no | integer | no | 0 | approved display order |
| pending_order_no | integer | yes | — | teacher changes |
| order_status | text | no | 'approved' | 'approved' / 'pending' |
| is_active | boolean | no | true | soft visibility |
| created_at | timestamptz | yes | now() | |

### Constraints
- PRIMARY KEY (id)
- UNIQUE (unit_id, order_no)
- FOREIGN KEY (unit_id) → units.id ON DELETE CASCADE

### Indexes
- idx_topics_unit_order (unit_id, order_no)
- unique_topics_slug (slug)

### Triggers
- BEFORE INSERT → set_topic_order_no()
- BEFORE INSERT OR UPDATE OF title → generate_slug_tr()

### SQL source


```sql
create table public.topics (
  id bigint generated by default as identity not null,
  unit_id bigint not null,
  title text not null,
  slug text null,
  order_no integer not null default 0,
  created_at timestamp with time zone null default now(),
  is_active boolean not null default true,
  pending_order_no integer null,
  order_status text not null default 'approved'::text,
  constraint topics_pkey primary key (id),
  constraint unique_unit_order unique (unit_id, order_no),
  constraint topics_unit_id_fkey foreign key (unit_id) references units (id) on delete cascade
);

create index if not exists idx_topics_unit_order
  on public.topics using btree (unit_id, order_no);

create unique index if not exists unique_topics_slug
  on public.topics using btree (slug);

create trigger trg_topics_order_no
before insert on topics
for each row
execute function set_topic_order_no();

create trigger trg_topics_slug
before insert or update of title on topics
for each row
execute function generate_slug_tr();


----------------------------------------------------------------------------------------------

## TABLE: outcomes

### Columns
| column | type | nullable | default | notes |
|------|------|---------|---------|------|
| id | bigint | no | auto | primary key |
| topic_id | bigint | yes | — | FK → topics.id |
| description | text | no | — | learning outcome |
| week_number | integer | no | — | curriculum week |
| order_index | integer | yes | — | ordering within topic/week |

### Constraints
- PRIMARY KEY (id)

### SQL source
```sql
create table public.outcomes (
  id bigint generated by default as identity not null,
  topic_id bigint null,
  description text not null,
  week_number integer not null,
  order_index integer null,
  constraint outcomes_pkey primary key (id)
);



---------------------------------------------------------------------------------------

## TABLE: lesson_grades

### Columns
| column    | type      | nullable | default | notes                         |
| --------- | --------- | -------- | ------- | ----------------------------- |
| id        | bigserial | no       | auto    | primary key                   |
| grade     | integer   | no       | —       | sınıf numarası (5–12)         |
| lesson_id | bigint    | no       | —       | lessons tablosuna foreign key |


### SQL source 


```sql
create table public.lesson_grades (
  id bigserial not null,
  grade integer not null,
  lesson_id bigint not null references public.lessons(id),
  constraint lesson_grades_pkey primary key (id)
);


-----------------------------------------------------------------------------------------------


## TABLE: topic_contents

| column       | type                     | nullable | default | notes                                             |
| ------------ | ------------------------ | -------- | ------- | ------------------------------------------------- |
| id           | bigint                   | no       | auto    | primary key, otomatik artan                       |
| topic_id     | bigint                   | no       | —       | topics tablosuna foreign key, CASCADE ile silinir |
| title        | text                     | no       | —       | içerik başlığı                                    |
| content      | text                     | no       | —       | içerik metni                                      |
| order_no     | integer                  | no       | 0       | sıralama numarası                                 |
| section_type | text                     | yes      | —       | içerik türü bölümü (örn: teori, uygulama)         |
| display_week | smallint                 | yes      | —       | hangi haftada gösterileceği                       |
| created_at   | timestamp with time zone | yes      | now()   | oluşturulma tarihi                                |
                             |


CREATE TABLE public.topic_contents (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
  topic_id BIGINT NOT NULL,
  title TEXT NOT NULL,
  content TEXT NOT NULL,
  order_no INTEGER NOT NULL DEFAULT 0,
  section_type TEXT NULL,
  display_week SMALLINT NULL,
  created_at TIMESTAMP WITH TIME ZONE NULL DEFAULT now(),
  CONSTRAINT topic_contents_pkey PRIMARY KEY (id),
  CONSTRAINT topic_contents_topic_id_fkey FOREIGN KEY (topic_id) REFERENCES topics (id) ON DELETE CASCADE
) TABLESPACE pg_default;

CREATE INDEX IF NOT EXISTS idx_topic_contents_topic_order
ON public.topic_contents USING btree (topic_id, order_no) TABLESPACE pg_default;






-----------------------------------------------------------------------------------------------


## TABLE: topic_videos


| column     | type                     | nullable | default | notes                                             |
| ---------- | ------------------------ | -------- | ------- | ------------------------------------------------- |
| id         | bigint                   | no       | auto    | primary key, identity sütunu                      |
| topic_id   | bigint                   | no       | —       | `topics` tablosuna foreign key, on delete CASCADE |
| title      | text                     | yes      | —       | video başlığı                                     |
| video_url  | text                     | no       | —       | video URL’i                                       |
| order_no   | integer                  | yes      | 0       | sıralama numarası                                 |
| created_at | timestamp with time zone | yes      | now()   | oluşturulma zamanı                                |



create table public.topic_videos (
  id bigint generated by default as identity not null,
  topic_id bigint not null,
  title text null,
  video_url text not null,
  order_no integer null default 0,
  created_at timestamp with time zone null default now(),
  constraint topic_videos_pkey primary key (id),
  constraint topic_videos_topic_id_fkey foreign key (topic_id) references public.topics (id) on delete cascade
) tablespace pg_default;

create index if not exists idx_topic_videos_topic 
on public.topic_videos using btree (topic_id, order_no) tablespace pg_default;

